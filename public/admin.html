<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>throughglasss | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { background: #020202; color: white; font-family: sans-serif; }
        .glass-panel { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); }
        input, textarea { background: #000; border: 1px solid #333; color: white; }
        input:focus, textarea:focus { border-color: #D4AF37; outline: none; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="login-gate" class="glass-panel p-10 rounded-xl text-center w-96">
        <h2 class="text-2xl text-[#D4AF37] font-serif mb-6">Admin Access</h2>
        <input type="password" id="pass" placeholder="Password" class="w-full p-3 rounded mb-4">
        <button id="login-btn" class="w-full bg-[#D4AF37] hover:bg-[#b8860b] text-black font-bold py-3 rounded transition">
            Enter Dashboard
        </button>
        <p id="error-msg" class="text-red-500 text-sm mt-4"></p>
    </div>

    <div id="dashboard" class="hidden w-full max-w-5xl p-6">
        <div class="glass-panel rounded-xl p-8">
            <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
                <h2 class="text-2xl font-serif text-[#D4AF37]">Inventory Manager</h2>
                <button id="logout-btn" class="text-gray-400 hover:text-white text-sm border border-gray-700 px-4 py-2 rounded">Logout</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <form id="add-form" class="space-y-4">
                    <h3 id="form-title" class="text-xl font-bold text-gray-300">Add Preset</h3>
                    <input id="p-name" placeholder="Name" class="w-full p-3 rounded" required>
                    <textarea id="p-desc" placeholder="Description" rows="3" class="w-full p-3 rounded" required></textarea>
                    <input id="p-price" placeholder="Price (e.g. $25)" class="w-full p-3 rounded" required>
                    <input id="p-img" placeholder="Image URL (Unsplash or Local)" class="w-full p-3 rounded" required>
                    <input id="p-link" placeholder="Gumroad Link" class="w-full p-3 rounded" required>
                    
                    <div class="flex gap-2 pt-2">
                        <button type="submit" id="submit-btn" class="flex-1 bg-[#D4AF37] hover:bg-[#b8860b] text-black font-bold py-3 rounded">Publish</button>
                        <button type="button" id="cancel-btn" class="hidden px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded">Cancel</button>
                    </div>
                </form>

                <div>
                    <h3 class="text-xl font-bold text-gray-300 mb-4 flex justify-between">
                        Live Products <span class="text-xs font-normal text-gray-500 pt-1">Drag handle (⋮⋮) to reorder</span>
                    </h3>
                    <div id="product-list" class="h-[500px] overflow-y-auto pr-2 space-y-2">
                        <p class="text-gray-500 text-sm">Loading products...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let editingId = null;
        let allItems = [];

        // --- AUTHENTICATION CHECK ---
        // This function handles "Invalid Token" errors automatically
        async function fetchWithAuth(url, options = {}) {
            if (!authToken) {
                logout();
                return null;
            }
            
            const headers = { ...options.headers, 'Authorization': `Bearer ${authToken}` };
            const res = await fetch(url, { ...options, headers });

            if (res.status === 401 || res.status === 403) {
                alert("⚠️ Session expired. Please log in again.");
                logout();
                return null;
            }
            return res;
        }

        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            toggleUI(false);
        }

        const toggleUI = (isLoggedIn) => {
            document.getElementById('login-gate').style.display = isLoggedIn ? 'none' : 'block';
            document.getElementById('dashboard').style.display = isLoggedIn ? 'block' : 'none';
            if(isLoggedIn) { loadItems(); initSortable(); }
        };

        // --- FORM HANDLING ---
        document.getElementById('add-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Saving...";
            
            const item = {
                name: document.getElementById('p-name').value,
                desc: document.getElementById('p-desc').value,
                price: document.getElementById('p-price').value,
                img: document.getElementById('p-img').value,
                link: document.getElementById('p-link').value
            };

            const url = editingId ? `/api/presets/${editingId}` : '/api/presets';
            const method = editingId ? 'PUT' : 'POST';
            
            const res = await fetchWithAuth(url, {
                method, 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item)
            });

            if (res && res.ok) {
                setEditMode(null);
                loadItems();
                alert("✅ Product Saved!");
            } else if (res) {
                alert("❌ Save Failed.");
            }
            btn.innerText = editingId ? "Update" : "Publish";
        });

        // --- LOAD ITEMS ---
        async function loadItems() {
            try {
                const res = await fetch('/api/presets');
                allItems = await res.json();
                
                const list = document.getElementById('product-list');
                if (allItems.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm">No products found.</p>';
                    return;
                }

                list.innerHTML = allItems.map(i => `
                    <div class="item-row flex justify-between items-center bg-[#111] p-3 rounded border border-[#333]" data-id="${i.id}">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="drag-handle cursor-grab text-gray-500 hover:text-white px-2">⋮⋮</div>
                            <img src="${i.img}" class="w-10 h-10 rounded object-cover border border-gray-700">
                            <div>
                                <div class="font-bold text-sm">${i.name}</div>
                                <div class="text-xs text-gray-500">${i.price}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editItem('${i.id}')" class="text-yellow-500 text-xs border border-yellow-900 px-2 py-1 rounded hover:bg-yellow-900/30">Edit</button>
                            <button onclick="delItem('${i.id}')" class="text-red-500 text-xs border border-red-900 px-2 py-1 rounded hover:bg-red-900/30">Del</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        // --- HELPERS ---
        const setEditMode = (item) => {
            if (item) {
                editingId = item.id;
                document.getElementById('p-name').value = item.name;
                document.getElementById('p-desc').value = item.desc;
                document.getElementById('p-price').value = item.price;
                document.getElementById('p-img').value = item.img;
                document.getElementById('p-link').value = item.link;
                document.getElementById('submit-btn').innerText = "Update";
                document.getElementById('cancel-btn').classList.remove('hidden');
            } else {
                editingId = null;
                document.getElementById('add-form').reset();
                document.getElementById('submit-btn').innerText = "Publish";
                document.getElementById('cancel-btn').classList.add('hidden');
            }
        };

        window.editItem = (id) => setEditMode(allItems.find(x => x.id === id));
        
        window.delItem = async (id) => {
            if(confirm('Delete this product?')) {
                await fetchWithAuth(`/api/presets/${id}`, { method: 'DELETE' });
                loadItems();
            }
        };

        function initSortable() {
            const el = document.getElementById('product-list');
            new Sortable(el, {
                handle: '.drag-handle', animation: 150, ghostClass: 'opacity-50',
                onEnd: () => {
                    const ids = Array.from(document.querySelectorAll('.item-row')).map(el => el.dataset.id);
                    fetchWithAuth('/api/presets/reorder', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order: ids })
                    });
                }
            });
        }

        // --- LOGIN ---
        document.getElementById('login-btn').addEventListener('click', async () => {
            const password = document.getElementById('pass').value;
            const res = await fetch('/api/auth/login', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'admin', password })
            });
            const data = await res.json();
            if (res.ok) {
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                toggleUI(true);
            } else {
                document.getElementById('error-msg').innerText = "Invalid Password";
            }
        });

        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('cancel-btn').addEventListener('click', () => setEditMode(null));

        // Start
        if (authToken) toggleUI(true);
    </script>
</body>
</html>